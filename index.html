<div id="FX_ROOT">
  <style>
    #PLAYER_EDITOR {
      background: #1a1a1a; color: white; padding: 20px; border-radius: 15px;
      font-family: 'Segoe UI', sans-serif; display: flex; gap: 20px; max-width: 900px;
    }
    .controls { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .preview-area { 
      flex: 1.2; background: rgba(255,255,255,0.05); border-radius: 15px;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    label { font-size: 11px; color: #888; text-transform: uppercase; }
    input, select, textarea { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #333; background: #222; color: white; margin-bottom: 5px; }
    .btn-get-code { 
      background: #00d9ff; color: #000; border: none; padding: 12px; 
      border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; width: 100%;
    }
    #PLAYER_VIEW {
      width: 280px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
      border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1);
    }
    .album-art { width: 100%; height: 140px; background: #333; border-radius: 10px; object-fit: cover; }
  </style>

  <div id="PLAYER_EDITOR">
    <div class="controls">
      <h3 style="margin:0 0 10px 0; color:#00d9ff;">Fix Music Player</h3>
      <label>Язык: <select id="p_lang"><option value="ru">Русский</option><option value="en">English</option></select></label>
      <label>Цвет: <input type="color" id="p_color" value="#00d9ff"></label>
      <label>Картинка (URL): <input type="text" id="p_img" value="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?w=400"></label>
      <label>Ссылки на MP3 (каждая с новой строки):</label>
      <textarea id="p_list" style="height:100px;">https://ryabchevskayav-pixel.github.io/audio/track1.mp3</textarea>
      <button class="btn-get-code" onclick="copyPlayerCode()">СКОПИРОВАТЬ ИСПРАВЛЕННЫЙ КОД</button>
    </div>

    <div class="preview-area">
      <div id="PLAYER_VIEW">
        <img id="prev_img" src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?w=400" class="album-art">
        <div style="font-weight:bold; margin-top:10px;">Preview</div>
        <div style="width:100%; height:4px; background:#444; margin:15px 0;"><div id="prev_bar" style="width:40%; height:100%; background:#00d9ff;"></div></div>
        <div style="font-size:24px;">⏮ ⏸ ⏭</div>
      </div>
    </div>
  </div>

  <script>
    function copyPlayerCode() {
      const color = document.getElementById('p_color').value;
      const img = document.getElementById('p_img').value;
      const lang = document.getElementById('p_lang').value;
      
      // Обработка ссылок: убираем пробелы и пустые строки
      let tracks = document.getElementById('p_list').value.split('\n')
        .map(s => s.trim())
        .filter(s => s.length > 5)
        .map(s => {
           // Если это обычная ссылка GitHub, меняем её на RAW
           if(s.includes('github.com') && !s.includes('raw.githubusercontent')) {
             return s.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
           }
           return s;
        });

      if (tracks.length === 0) { alert('Добавьте хотя бы одну ссылку!'); return; }

      const finalCode = `<div id="GENIALLY_PLAYER" style="display:flex; justify-content:center; background:transparent; font-family: sans-serif;">
  <style>
    .player-card {
      width: 300px; background: rgba(15, 15, 15, 0.7); backdrop-filter: blur(12px);
      border-radius: 20px; padding: 20px; color: white; text-align: center;
      border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 15px 35px rgba(0,0,0,0.5);
    }
    .art { width: 100%; height: 160px; border-radius: 12px; object-fit: cover; margin-bottom: 15px; }
    .slider { width: 100%; accent-color: ${color}; margin: 15px 0; cursor: pointer; }
    .controls { display: flex; justify-content: space-between; align-items: center; }
    .play-btn { background: ${color}; color: black; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
    .nav-btn { cursor: pointer; font-size: 20px; opacity: 0.8; }
    .nav-btn:hover { opacity: 1; }
  </style>

  <div class="player-card">
    <img src="${img}" class="art">
    <div id="track_title" style="font-size: 14px; font-weight: bold; height: 20px; overflow: hidden;">Loading...</div>
    <input type="range" id="seek" class="slider" value="0" step="0.1">
    <div class="controls">
      <span class="nav-btn" onclick="audioPlayer.prev()">⏮</span>
      <div class="play-btn" id="play_status" onclick="audioPlayer.toggle()">▶</div>
      <span class="nav-btn" onclick="audioPlayer.next()">⏭</span>
    </div>
    <div id="error_log" style="font-size: 10px; color: #ff4444; margin-top: 10px;"></div>
  </div>

  <script>
    var audioPlayer = {
      list: ${JSON.stringify(tracks)},
      index: 0,
      audio: new Audio(),
      init: function() {
        this.audio.crossOrigin = "anonymous";
        this.load();
        this.audio.ontimeupdate = () => {
          if(!isNaN(this.audio.duration))
            document.getElementById('seek').value = (this.audio.currentTime / this.audio.duration) * 100;
        };
        this.audio.onended = () => this.next();
        this.audio.onerror = () => {
           document.getElementById('error_log').innerText = "${lang === 'ru' ? 'Ошибка загрузки файла' : 'Audio load error'}";
        };
        document.getElementById('seek').oninput = (e) => {
          this.audio.currentTime = (e.target.value / 100) * this.audio.duration;
        };
      },
      load: function() {
        document.getElementById('error_log').innerText = "";
        this.audio.src = this.list[this.index];
        const name = this.list[this.index].split('/').pop().replace('.mp3', '');
        document.getElementById('track_title').innerText = decodeURI(name);
      },
      toggle: function() {
        if(this.audio.paused) {
          this.audio.play().catch(e => {
            document.getElementById('error_log').innerText = "${lang === 'ru' ? 'Кликните еще раз для запуска' : 'Click again to play'}";
          });
          document.getElementById('play_status').innerText = '⏸';
        } else {
          this.audio.pause();
          document.getElementById('play_status').innerText = '▶';
        }
      },
      next: function() { this.index = (this.index + 1) % this.list.length; this.load(); this.audio.play(); },
      prev: function() { this.index = (this.index - 1 + this.list.length) % this.list.length; this.load(); this.audio.play(); }
    };
    audioPlayer.init();
  <\/script>
</div>`;

      const el = document.createElement('textarea');
      el.value = finalCode;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      alert('Код скопирован! Теперь вставьте его в Genially.');
    }
  </script>
</div>
